<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kawaii Dreams</title>
<style>
  :root{--accent:#ff66b2;--muted:#666}
  body{font-family:Inter,system-ui,Arial;background:#fff;margin:0;color:#111}
  header{padding:18px 16px;text-align:center;font-weight:700;font-size:22px;border-bottom:1px solid #eee}
  .container{max-width:980px;margin:12px auto;padding:12px}
  .search{margin-bottom:12px}
  .search input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:15px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .card{border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06);overflow:hidden;background:#fff;display:flex;flex-direction:column}
  .thumb{height:160px;background:#f4f4f4;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .card-body{padding:10px;flex:1;display:flex;flex-direction:column;gap:8px}
  .title{font-weight:600;font-size:15px;min-height:36px}
  .btn-row{display:flex;gap:8px;align-items:center}
  .btn{flex:1;padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  .small{padding:6px 8px;font-size:13px}
  .toast{position:fixed;left:14px;bottom:80px;background:rgba(0,0,0,0.8);color:#fff;padding:8px 12px;border-radius:8px;display:none}
  .floating-tg{position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:50%;background:#0088cc;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;text-decoration:none;box-shadow:0 10px 24px rgba(0,0,0,0.12);animation:float 3s ease-in-out infinite}
  @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
  footer{padding:12px;text-align:center;border-top:1px solid #f0f0f0;color:var(--muted);position:fixed;left:0;right:0;bottom:0;background:#fff}
  .download-btn{background:#2e7d32}
  .disabled{opacity:0.6;pointer-events:none}
  .badge{font-size:12px;color:var(--muted)}
</style>
<!-- Monetag Telegram Mini App SDK (your provided snippet) -->
<script src="//libtl.com/sdk.js" data-zone="9906722" data-sdk="show_9906722"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>
  <header>Kawaii Dreams</header>

  <div class="container">
    <div class="search">
      <input id="searchInput" placeholder="Search by title or tags and press Enter" />
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Floating Telegram (link placeholder provided earlier) -->
  <a class="floating-tg" href="https://t.me/+je3SYj65zM84MzRl" target="_blank" title="Join Telegram">TG</a>

  <footer>
    Made By XBI<br>
    <a href="https://t.me/+l8Zk3taERx4xZWE1" target="_blank">Contact</a>
  </footer>

<script>
/* -------------------------
  Config: Firebase (you provided)
--------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyBvEdciF6GYzOBoWTNKaF-PrjpVtAiMwfc",
  authDomain: "kawaii-dreams.firebaseapp.com",
  databaseURL: "https://kawaii-dreams-default-rtdb.firebaseio.com",
  projectId: "kawaii-dreams",
  storageBucket: "kawaii-dreams.firebasestorage.app",
  messagingSenderId: "249963553173",
  appId: "1:249963553173:web:187a55f3933feea14a169c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -------------------------
  Helpers & UI
--------------------------*/
const grid = document.getElementById('grid');
const toastEl = document.getElementById('toast');
function showToast(msg,ms=2000){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',ms); }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------------
  Load posts and render
  Each post structure (in Firestore `posts` collection) expected:
  { postId, title, imageUrl, originalDownloadURL, requiredAdsToDownload, monetagDirectLink, enableGetDirectLinkButton, enableWatchAdsButton, tags }
--------------------------*/
async function loadPosts() {
  grid.innerHTML = 'Loading...';
  const snap = await db.collection('posts').orderBy('createdAt','desc').get();
  grid.innerHTML = '';
  snap.forEach(doc=>{
    const p = doc.data();
    const pid = doc.id;
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="thumb"><img src="${escapeHtml(p.imageUrl|| '')}" alt=""></div>
      <div class="card-body">
        <div class="title">${escapeHtml(p.title||'Untitled')}</div>
        <div class="badge">Ads to unlock: ${p.requiredAdsToDownload||0}</div>
        <div class="btn-row" style="margin-top:auto">
          ${p.enableWatchAdsButton? `<button class="btn small" data-action="watch" data-id="${pid}">Watch Ads</button>` : ''}
          ${p.enableGetDirectLinkButton? `<button class="btn small ghost" data-action="direct" data-id="${pid}">Get Direct Link</button>` : ''}
          <button class="btn small ghost" data-action="share" data-id="${pid}">Share</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });
  attachGridEvents();
}

/* -------------------------
  Attach events
--------------------------*/
function attachGridEvents(){
  document.querySelectorAll('[data-action="watch"]').forEach(btn=>{
    btn.onclick = () => startWatchFlow(btn);
  });
  document.querySelectorAll('[data-action="direct"]').forEach(btn=>{
    btn.onclick = () => openDirectAd(btn.dataset.id);
  });
  document.querySelectorAll('[data-action="share"]').forEach(btn=>{
    btn.onclick = () => copyShare(btn.dataset.id);
  });
}

/* -------------------------
  Watch Ads Flow
  - Use Monetag Mini App SDK: show_9906722()
  - After each ad completes: hide button, show 3s timer inplace, bottom-left toast shows for 2s
  - Repeat until requiredAdsToDownload reached; then enable download prompt (redirect)
--------------------------*/
async function startWatchFlow(buttonEl){
  const postId = buttonEl.dataset.id;
  const doc = await db.collection('posts').doc(postId).get();
  if(!doc.exists) return alert('Post missing');
  const data = doc.data();

  // session counter stored in localStorage
  const key = `watched_${postId}`;
  let watched = parseInt(localStorage.getItem(key) || '0',10);

  // if already unlocked
  if(watched >= (data.requiredAdsToDownload||0)){
    // show direct download prompt
    if(confirm('Download unlocked. Open download?')) window.open(data.originalDownloadURL,'_blank');
    return;
  }

  try{
    // show Monetag rewarded interstitial (Telegram Mini App)
    await show_9906722(); // returns when ad watched / resolved
    watched += 1;
    localStorage.setItem(key, watched);

    // Replace button with timer element (3s)
    const parent = buttonEl.parentElement;
    const timerEl = document.createElement('div');
    timerEl.style.padding = '8px 12px';
    timerEl.style.borderRadius = '8px';
    timerEl.style.background = '#f1f1f1';
    timerEl.style.color = '#333';
    timerEl.textContent = 'Next ad will start in 3 seconds...';
    parent.replaceChild(timerEl, buttonEl);

    // bottom-left notification (2s then disappear)
    showToast('⏳ Wait for 3 seconds...',2000);

    // countdown visible inside timerEl
    let c = 3;
    const iv = setInterval(()=>{
      c--;
      if(c>0) timerEl.textContent = `Next ad will start in ${c} seconds...`;
      else {
        clearInterval(iv);
        // restore button
        parent.replaceChild(buttonEl, timerEl);
      }
    },1000);

    // After increment, check if completed
    if(watched >= (data.requiredAdsToDownload||0)){
      // Unlock: show success toast and ask to open download
      showToast('✅ Ads completed! Download unlocked.',2000);
      setTimeout(()=> {
        if(confirm('Open download link now?')) window.open(data.originalDownloadURL,'_blank');
      }, 800);
    }
  }catch(err){
    console.error('Ad error/cancelled',err);
    alert('Ad failed or was cancelled.');
  }
}

/* -------------------------
  Direct Link Flow
  - Use Monetag rewarded popup: show_9906722('pop')
  - Maintain localStorage counter direct_count_{postId}; after 7 direct ad views => auto redirect to originalDownloadURL
  - Also open provided direct ad link after each view (recycled ads behavior)
  - Remove "notification" after direct ad as requested (i.e., do not show extra results/notification)
--------------------------*/
async function openDirectAd(postId){
  const doc = await db.collection('posts').doc(postId).get();
  if(!doc.exists) return alert('Post missing');
  const data = doc.data();
  const directAd = data.monetagDirectLink || 'https://otieu.com/4/9908200';
  const key = `direct_count_${postId}`;
  let cnt = parseInt(localStorage.getItem(key) || '0',10);

  try{
    await show_9906722('pop'); // rewarded popup format
    cnt++; localStorage.setItem(key, cnt);
    if(cnt >= 7){
      // after 7 direct ad views -> redirect to download link
      window.open(data.originalDownloadURL,'_blank');
      return;
    }
    // open the monetag direct ad link (recycled)
    window.open(directAd,'_blank');
  }catch(e){
    console.error('Direct ad error',e);
    // fallback: still open direct ad link
    window.open(directAd,'_blank');
  }
}

/* -------------------------
  Copy Share Link (use your provided base)
  Format required: t.me/Kawaii_dreams_bot/ani_mix + pass post id so mini app shows that post
  We'll use deep link style: https://t.me/Kawaii_dreams_bot/ani_mix?startapp=POST_ID
--------------------------*/
function copyShare(postId){
  const link = `https://t.me/Kawaii_dreams_bot/ani_mix?startapp=${postId}`;
  navigator.clipboard.writeText(link).then(()=> showToast('Share link copied!',1400));
}

/* -------------------------
  Search behavior:
  - If user presses Enter, show Monetag Telegram Mini App ad BEFORE showing results.
  - After ad finishes (or on error), show direct results (no "showing results" notification)
--------------------------*/
const input = document.getElementById('searchInput');
input.addEventListener('keydown', async (e)=>{
  if(e.key !== 'Enter') return;
  const q = input.value.trim().toLowerCase();
  if(!q) { loadPosts(); return; }
  try{
    await show_9906722(); // show ad before results
  }catch(err){
    console.error('Search ad failed', err);
  }
  // now query Firestore and show filtered results
  const snap = await db.collection('posts').get();
  grid.innerHTML = '';
  snap.forEach(doc=>{
    const p = doc.data();
    const hay = `${(p.title||'') +' '+ (p.tags||'')}`.toLowerCase();
    if(hay.indexOf(q) !== -1) {
      const pid = doc.id;
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `
        <div class="thumb"><img src="${escapeHtml(p.imageUrl|| '')}" alt=""></div>
        <div class="card-body">
          <div class="title">${escapeHtml(p.title||'Untitled')}</div>
          <div class="badge">Ads to unlock: ${p.requiredAdsToDownload||0}</div>
          <div class="btn-row" style="margin-top:auto">
            ${p.enableWatchAdsButton? `<button class="btn small" data-action="watch" data-id="${pid}">Watch Ads</button>` : ''}
            ${p.enableGetDirectLinkButton? `<button class="btn small ghost" data-action="direct" data-id="${pid}">Get Direct Link</button>` : ''}
            <button class="btn small ghost" data-action="share" data-id="${pid}">Share</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    }
  });
  attachGridEvents(); // reattach events
});

/* -------------------------
  Auto-ads when user stays long inside Mini App:
  - If user is idle for 60 seconds on this page, show an automatic Monetag ad.
  - Reset timer when user interacts.
--------------------------*/
let idleTimer;
function resetIdle(){ clearTimeout(idleTimer); idleTimer = setTimeout(()=>{ try{ show_9906722().catch(()=>{}); }catch(e){} }, 60000); }
['mousemove','touchstart','click','keydown'].forEach(ev=> window.addEventListener(ev, resetIdle));
resetIdle();

/* -------------------------
  Initial
--------------------------*/
loadPosts();
</script>
</body>
</html>
